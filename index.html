
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>BUILDING NON-LINEAR ANALYSIS TOOLS FOR C-PAC</title>
  <meta name="author" content="github.com/erramuzpe">

  
  <meta name="description" content="As planned in the previous week, an extensive code reviewing and commenting has been carried out during this last week of coding. Major objectives in &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://erramuzpe.github.io/C-PAC/">
  <link href="/C-PAC/favicon.png" rel="icon">
  <link href="/C-PAC/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/C-PAC/atom.xml" rel="alternate" title="BUILDING NON-LINEAR ANALYSIS TOOLS FOR C-PAC" type="application/atom+xml">
  <script src="/C-PAC/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/C-PAC/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/C-PAC/">BUILDING NON-LINEAR ANALYSIS TOOLS FOR C-PAC</a></h1>
  
    <h2>Contributing to C-PAC</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/C-PAC/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="sitesearch" value="erramuzpe.github.io/C-PAC">
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/C-PAC/">Blog</a></li>
  <li><a href="/C-PAC/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/C-PAC/blog/2015/08/20/last-week-of-coding-time-for-reviewing-and-documenting/">Last Week of Coding: Time for Reviewing and Documenting</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-08-20T15:32:14+02:00'><span class='date'><span class='date-month'>Aug</span> <span class='date-day'>20</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>3:32 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>As planned in the previous week, an extensive code reviewing and commenting has been carried out during this last week of coding. Major objectives in this code revision were to fix small bugs, to have a common standard for function&rsquo;s headers, to have commented the main aspects of the functions and to make a full cleaning of the code (with the aim of being as much readable as possible). Many lines of code have been added as explanation of the measures and this was helpful also for the documentation work that we have started in collaboration with John.</p>

<p>It is also important to make comments with regard to possibilities that the developed tools have for future uses (combinations of measures, links to other modules&hellip;), or outputs relevant to the technique. To this aspect we have both put our hands on. This is also being added as documentation inside the scripts, as well as some easy procedures to make figures as the ones showed in this blog.</p>

<p>Moreover, some linker function calls have been inserted (e.g. the ones to make the calls to GC module and a full new workflow dedicated to criticality, since this was the one with different data input). With regard to GC module, as we had some strange behaviour on a transformation, we have contacted the developers of the MVGC toolbox and we are involved in discussion with Dr. L. Barnett regard to this issue, engaging well on what it could be a helping hand. We will keep working on this during next week.</p>

<h2><strong> Running experiments in the cluster </strong></h2>

<p>Further, this week it&rsquo;s been really fruitful from the point of view of the data analysis. We have been able to build scripts to make our tests run @IFISC cluster, so we can make use of parallelization to calculate our measures over large datasets. To make a first approach, we have been able to compute the whole clustering (1 and 2 neighbours approach) + the avalanche detection for a dataset of 139 subjects in less than 30 mins (it was an average of 20 mins for each subject in my own PC). This will allow us to make extensive data analyzing with the measures and discuss and note parameters as we do document and consider the impact of measures and their preeminence.</p>

<p>As example, here we show a small analysis between 2 groups of 21 subjects (autism and non-autism patients). The number of avalanches and the number of voxels belonging to an avalanche calculated after 2 neighbour clustering have been studied:</p>

<p><img class="center" src="/C-PAC/images/autist.png" width="700" height="700" title="image" alt="image"></p>

<p>Means over groups and the ratio voxel_number per avalanche were also calculated over groups and differences were neither appreciate. More analyses had to be done, like computing the average lifetime of an avalanche and the avalanche-wise size.</p>

<h2><strong> Last week&rsquo;s objectives </strong></h2>

<p>Our objectives for the last week are:</p>

<ul>
<li><p>Make last corrections and finalize documentation work as far as possible. In this task, we are going through the code to make insertions that would describe links between measures, graphics of interests, etc</p></li>
<li><p>Evaluate the work done. Achievements / Fails as to create a little memorandum for the delivery, and possible lines for collaboration</p></li>
<li><p>Pack the code and submit, in agreement with John and hoping to get impressions too</p></li>
<li><p>Close project, open future: Make the toolbox more fruitful and better suited. Keep a line of communication for helping on further developments and distend chat about future ideas, and thank so much the team for accommodating us!</p></li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/C-PAC/blog/2015/08/14/clustering-and-avalanche-detection-algorithms/">Clustering and Avalanche Detection Algorithms</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-08-14T13:10:51+02:00'><span class='date'><span class='date-month'>Aug</span> <span class='date-day'>14</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>1:10 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>This week, as planned from the previous one, the integration has been extensively worked: the <em>cpac_pipeline.py</em> has now our workflow fully integrated and I have change the workflows into a single one, making it easier the call to the methods. Also, the treatment of the inputs has changed, since we are not making the extraction of the series anymore (another module of C-PAC is taking the responsibility). But more interestingly, we have enforced the Criticality package with the correction of the Point Process and Conditional Rate Mapping from the previous week and the developing of 2 new functions: Clustering and Avalanche detection algorithms.</p>

<p>For this algorithms, we have also followed the headlines explained in the paper of <a href="http://journal.frontiersin.org/article/10.3389/fphys.2012.00015/abstract">Tagliazucchi et al</a> (&ldquo;<em>Criticality in large-scale brain fMRI dynamics unveiled by a novel point process analysis</em>&rdquo;), we have been able to extract Avalanches in the brain, wich opens a new perspective in the analysis of brain dynamics in C-PAC.</p>

<h2><strong> Clustering Detection  </strong></h2>

<p>The technique is described, extracted from the section  <em>Methods</em> of the paper, as:</p>

<p><em>To detect contiguous clusters of activated voxels (defined as those crossing the threshold), for each time step, the problem was reduced to the detection of connected components in a suitably defined graph or network. More precisely, for each volume, a graph was constructed having each voxel as a node, and two nodes connected with a link if they were both activated (BOLD signal above 1 SD) and also first neighbors in the spatial sense. The connected components of this graph correspond to clusters of contiguous activated voxels isolated from other similarly defined clusters.</em></p>

<p>The implementation of this approach was straightforward, but it has many checks to do, so it is an algorithm to code very carefully. It is a first draft of the algorithm and the purpose was to have a functional procedure asap. In future revisions, I will try to rewrite it in a more “pythonic way”.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
</pre></td><td class='code'><pre><code class='py'><span class='line'><span class="c"># Detects clusters after Point Processing a Brain </span>
</span><span class='line'><span class="k">def</span> <span class="nf">cluster_detection</span><span class="p">(</span><span class="n">in_file</span><span class="p">):</span>
</span><span class='line'>
</span><span class='line'>    <span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
</span><span class='line'>    <span class="kn">import</span> <span class="nn">os</span>
</span><span class='line'>    <span class="kn">import</span> <span class="nn">nibabel</span> <span class="kn">as</span> <span class="nn">nb</span>
</span><span class='line'>    <span class="kn">from</span> <span class="nn">CPAC.criticallity</span> <span class="kn">import</span> <span class="n">point_process</span>
</span><span class='line'>
</span><span class='line'>    <span class="c"># Treat fMRI image</span>
</span><span class='line'>    <span class="n">img</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">in_file</span><span class="p">)</span>
</span><span class='line'>    <span class="n">data</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span>
</span><span class='line'>    <span class="p">(</span><span class="n">n_x</span><span class="p">,</span> <span class="n">n_y</span><span class="p">,</span> <span class="n">n_z</span><span class="p">,</span> <span class="n">n_t</span><span class="p">)</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span>
</span><span class='line'>
</span><span class='line'>    <span class="c"># Get the PP data</span>
</span><span class='line'>    <span class="n">pp_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_x</span><span class="p">,</span> <span class="n">n_y</span><span class="p">,</span> <span class="n">n_z</span><span class="p">,</span> <span class="n">n_t</span><span class="p">))</span>
</span><span class='line'>    <span class="k">for</span> <span class="n">i_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_x</span><span class="p">):</span>
</span><span class='line'>        <span class="k">for</span> <span class="n">j_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_y</span><span class="p">):</span>
</span><span class='line'>            <span class="k">for</span> <span class="n">k_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_z</span><span class="p">):</span>
</span><span class='line'>                <span class="n">voxel_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">i_</span><span class="p">,</span><span class="n">j_</span><span class="p">,</span><span class="n">k_</span><span class="p">,:]</span>
</span><span class='line'>                <span class="n">pp_data</span><span class="p">[</span><span class="n">i_</span><span class="p">,</span><span class="n">j_</span><span class="p">,</span><span class="n">k_</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">point_process</span><span class="p">(</span><span class="n">voxel_data</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">cluster_graph_data_total</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_x</span><span class="p">,</span> <span class="n">n_y</span><span class="p">,</span> <span class="n">n_z</span><span class="p">,</span> <span class="n">n_t</span><span class="p">))</span>
</span><span class='line'>    <span class="k">for</span> <span class="n">t_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_t</span><span class="p">):</span>
</span><span class='line'>        <span class="n">time_slice</span> <span class="o">=</span> <span class="n">pp_data</span><span class="p">[:,:,:,</span><span class="n">t_</span><span class="p">]</span>
</span><span class='line'>        <span class="n">cluster_graph_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_x</span><span class="p">,</span> <span class="n">n_y</span><span class="p">,</span> <span class="n">n_z</span><span class="p">))</span>
</span><span class='line'>        <span class="n">cluster_number</span> <span class="o">=</span> <span class="mi">1</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">for</span> <span class="n">i_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_x</span><span class="p">):</span>
</span><span class='line'>            <span class="k">for</span> <span class="n">j_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_y</span><span class="p">):</span>
</span><span class='line'>                <span class="k">for</span> <span class="n">k_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_z</span><span class="p">):</span>
</span><span class='line'>
</span><span class='line'>                    <span class="k">if</span> <span class="n">time_slice</span><span class="p">[</span><span class="n">i_</span><span class="p">,</span><span class="n">j_</span><span class="p">,</span><span class="n">k_</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> <span class="c"># is active, check if it has active neighboours</span>
</span><span class='line'>                        <span class="k">if</span> <span class="n">time_slice</span><span class="p">[</span><span class="n">i_</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">j_</span><span class="p">,</span><span class="n">k_</span><span class="p">]</span> <span class="ow">or</span> <span class="n">time_slice</span><span class="p">[</span><span class="n">i_</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j_</span><span class="p">,</span><span class="n">k_</span><span class="p">]</span> \
</span><span class='line'>                        <span class="ow">or</span> <span class="n">time_slice</span><span class="p">[</span><span class="n">i_</span><span class="p">,</span><span class="n">j_</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">k_</span><span class="p">]</span> <span class="ow">or</span> <span class="n">time_slice</span><span class="p">[</span><span class="n">i_</span><span class="p">,</span><span class="n">j_</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">k_</span><span class="p">]</span> \
</span><span class='line'>                        <span class="ow">or</span> <span class="n">time_slice</span><span class="p">[</span><span class="n">i_</span><span class="p">,</span><span class="n">j_</span><span class="p">,</span><span class="n">k_</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">or</span> <span class="n">time_slice</span><span class="p">[</span><span class="n">i_</span><span class="p">,</span><span class="n">j_</span><span class="p">,</span><span class="n">k_</span><span class="o">+</span><span class="mi">1</span><span class="p">]:</span>
</span><span class='line'>
</span><span class='line'>                            <span class="k">if</span> <span class="n">cluster_graph_data</span><span class="p">[</span><span class="n">i_</span><span class="p">,</span><span class="n">j_</span><span class="p">,</span><span class="n">k_</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="c"># if is not in any previous cluster</span>
</span><span class='line'>                                <span class="n">this_cluster</span> <span class="o">=</span> <span class="p">(</span><span class="n">cluster_graph_data</span><span class="p">[</span><span class="n">i_</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">j_</span><span class="p">,</span><span class="n">k_</span><span class="p">]</span> <span class="ow">or</span> <span class="n">cluster_graph_data</span><span class="p">[</span><span class="n">i_</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j_</span><span class="p">,</span><span class="n">k_</span><span class="p">]</span> \
</span><span class='line'>                                <span class="ow">or</span> <span class="n">cluster_graph_data</span><span class="p">[</span><span class="n">i_</span><span class="p">,</span><span class="n">j_</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">k_</span><span class="p">]</span> <span class="ow">or</span> <span class="n">cluster_graph_data</span><span class="p">[</span><span class="n">i_</span><span class="p">,</span><span class="n">j_</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">k_</span><span class="p">]</span> \
</span><span class='line'>                                <span class="ow">or</span> <span class="n">cluster_graph_data</span><span class="p">[</span><span class="n">i_</span><span class="p">,</span><span class="n">j_</span><span class="p">,</span><span class="n">k_</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">or</span> <span class="n">cluster_graph_data</span><span class="p">[</span><span class="n">i_</span><span class="p">,</span><span class="n">j_</span><span class="p">,</span><span class="n">k_</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
</span><span class='line'>
</span><span class='line'>                                <span class="k">if</span> <span class="n">this_cluster</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="c">#no neighbours in any previous cluster neither</span>
</span><span class='line'>                                    <span class="n">this_cluster</span> <span class="o">=</span> <span class="n">cluster_number</span>
</span><span class='line'>                                    <span class="n">cluster_graph_data</span><span class="p">[</span><span class="n">i_</span><span class="p">,</span><span class="n">j_</span><span class="p">,</span><span class="n">k_</span><span class="p">]</span> <span class="o">=</span> <span class="n">this_cluster</span>
</span><span class='line'>                                    <span class="n">cluster_number</span> <span class="o">=</span> <span class="n">cluster_number</span> <span class="o">+</span> <span class="mi">1</span>
</span><span class='line'>                                <span class="k">else</span><span class="p">:</span>
</span><span class='line'>                                    <span class="c">#check cluster union</span>
</span><span class='line'>                                    <span class="n">merge_clusters</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">([</span><span class="n">cluster_graph_data</span><span class="p">[</span><span class="n">i_</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">j_</span><span class="p">,</span><span class="n">k_</span><span class="p">],</span> <span class="n">cluster_graph_data</span><span class="p">[</span><span class="n">i_</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j_</span><span class="p">,</span><span class="n">k_</span><span class="p">]</span> \
</span><span class='line'>                                <span class="p">,</span> <span class="n">cluster_graph_data</span><span class="p">[</span><span class="n">i_</span><span class="p">,</span><span class="n">j_</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">k_</span><span class="p">],</span> <span class="n">cluster_graph_data</span><span class="p">[</span><span class="n">i_</span><span class="p">,</span><span class="n">j_</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">k_</span><span class="p">]</span> \
</span><span class='line'>                                <span class="p">,</span> <span class="n">cluster_graph_data</span><span class="p">[</span><span class="n">i_</span><span class="p">,</span><span class="n">j_</span><span class="p">,</span><span class="n">k_</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">cluster_graph_data</span><span class="p">[</span><span class="n">i_</span><span class="p">,</span><span class="n">j_</span><span class="p">,</span><span class="n">k_</span><span class="o">+</span><span class="mi">1</span><span class="p">]])</span>
</span><span class='line'>                                    <span class="n">merge_clusters</span> <span class="o">=</span> <span class="n">merge_clusters</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="c">#quit first value = 0</span>
</span><span class='line'>
</span><span class='line'>                                    <span class="n">this_cluster</span> <span class="o">=</span> <span class="n">merge_clusters</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span class='line'>                                    <span class="n">cluster_graph_data</span><span class="p">[</span><span class="n">i_</span><span class="p">,</span><span class="n">j_</span><span class="p">,</span><span class="n">k_</span><span class="p">]</span> <span class="o">=</span> <span class="n">this_cluster</span>
</span><span class='line'>                                    <span class="k">for</span> <span class="n">cluster_to_merge</span> <span class="ow">in</span> <span class="n">merge_clusters</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
</span><span class='line'>                                        <span class="n">cluster_graph_data</span><span class="p">[</span><span class="n">cluster_graph_data</span> <span class="o">==</span> <span class="n">cluster_to_merge</span><span class="p">]</span> <span class="o">=</span> <span class="n">this_cluster</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>                            <span class="k">else</span><span class="p">:</span>
</span><span class='line'>                                <span class="n">this_cluster</span> <span class="o">=</span> <span class="n">cluster_graph_data</span><span class="p">[</span><span class="n">i_</span><span class="p">,</span><span class="n">j_</span><span class="p">,</span><span class="n">k_</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'>                            <span class="c">#find neighbours and give cluster_number</span>
</span><span class='line'>                            <span class="k">if</span> <span class="n">time_slice</span><span class="p">[</span><span class="n">i_</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">j_</span><span class="p">,</span><span class="n">k_</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span class='line'>                                <span class="n">cluster_graph_data</span><span class="p">[</span><span class="n">i_</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">j_</span><span class="p">,</span><span class="n">k_</span><span class="p">]</span> <span class="o">=</span> <span class="n">this_cluster</span>
</span><span class='line'>                            <span class="k">elif</span> <span class="n">time_slice</span><span class="p">[</span><span class="n">i_</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j_</span><span class="p">,</span><span class="n">k_</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span class='line'>                                <span class="n">cluster_graph_data</span><span class="p">[</span><span class="n">i_</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j_</span><span class="p">,</span><span class="n">k_</span><span class="p">]</span> <span class="o">=</span> <span class="n">this_cluster</span>
</span><span class='line'>                            <span class="k">elif</span> <span class="n">time_slice</span><span class="p">[</span><span class="n">i_</span><span class="p">,</span><span class="n">j_</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">k_</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span class='line'>                                <span class="n">cluster_graph_data</span><span class="p">[</span><span class="n">i_</span><span class="p">,</span><span class="n">j_</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">k_</span><span class="p">]</span> <span class="o">=</span> <span class="n">this_cluster</span>
</span><span class='line'>                            <span class="k">elif</span> <span class="n">time_slice</span><span class="p">[</span><span class="n">i_</span><span class="p">,</span><span class="n">j_</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">k_</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span class='line'>                                <span class="n">cluster_graph_data</span><span class="p">[</span><span class="n">i_</span><span class="p">,</span><span class="n">j_</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">k_</span><span class="p">]</span> <span class="o">=</span> <span class="n">this_cluster</span>
</span><span class='line'>                            <span class="k">elif</span> <span class="n">time_slice</span><span class="p">[</span><span class="n">i_</span><span class="p">,</span><span class="n">j_</span><span class="p">,</span><span class="n">k_</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span class='line'>                                <span class="n">cluster_graph_data</span><span class="p">[</span><span class="n">i_</span><span class="p">,</span><span class="n">j_</span><span class="p">,</span><span class="n">k_</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">this_cluster</span>
</span><span class='line'>                            <span class="k">elif</span> <span class="n">time_slice</span><span class="p">[</span><span class="n">i_</span><span class="p">,</span><span class="n">j_</span><span class="p">,</span><span class="n">k_</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span class='line'>
</span><span class='line'>                    <span class="c"># if not == 1¡, keep the search </span>
</span><span class='line'>                        <span class="c"># if not neighbours, keep the search</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">cluster_graph_data_total</span><span class="p">[:,:,:,</span><span class="n">t_</span><span class="p">]</span> <span class="o">=</span> <span class="n">cluster_graph_data</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="n">cluster_graph_data_total</span>
</span></code></pre></td></tr></table></div></figure>


<h2><strong> Avalanche Detection </strong></h2>

<p>The technique can be easily described, extracted from the section  <em>Methods</em> of the paper:</p>

<p><em>The point process is defined by the sequences of time points at which the BOLD signal crosses a given threshold from below. (&hellip;) To construct the conditional rates the point process is defined at a seed location and at the targets throughout the entire brain. The BOLD signal is extracted from a seed region (top trace) and the points (arrows and vertical dashed lines) are defined by the crossings at 1 SD (horizontal dashed lines). Every time the signal at a target region crosses the threshold (asterisks) up to 2 time steps later than in the seed, the rate at the target is increased in one unit. This rate is normalized by the number of points in the seed. The top panel shows the location of the seed and of the two example targets, as well as the resulting average conditional rates maps (left) and DMN obtained from PICA (right). Medium panels show the BOLD signal at the seed and at the two example target regions.</em></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
</pre></td><td class='code'><pre><code class='py'><span class='line'><span class="k">def</span> <span class="nf">avalanche_detec</span><span class="p">(</span><span class="n">cluster_file</span><span class="p">):</span>
</span><span class='line'>
</span><span class='line'>    <span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
</span><span class='line'>    <span class="kn">import</span> <span class="nn">nibabel</span> <span class="kn">as</span> <span class="nn">nb</span>
</span><span class='line'>    <span class="kn">import</span> <span class="nn">os</span>
</span><span class='line'>
</span><span class='line'>    <span class="c"># Treat fMRI image</span>
</span><span class='line'>    <span class="n">img</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">cluster_file</span><span class="p">)</span>
</span><span class='line'>    <span class="n">cluster_data</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span>
</span><span class='line'>    <span class="p">(</span><span class="n">n_x</span><span class="p">,</span> <span class="n">n_y</span><span class="p">,</span> <span class="n">n_z</span><span class="p">,</span> <span class="n">n_t</span><span class="p">)</span> <span class="o">=</span> <span class="n">cluster_data</span><span class="o">.</span><span class="n">shape</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">avalanche_id_total</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_x</span><span class="p">,</span> <span class="n">n_y</span><span class="p">,</span> <span class="n">n_z</span><span class="p">,</span> <span class="n">n_t</span><span class="p">))</span>
</span><span class='line'>    <span class="n">avalanche_id_num</span> <span class="o">=</span> <span class="mi">1</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">for</span> <span class="n">t_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_t</span><span class="p">):</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="n">t_</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="c">#if first timestep, all are candidates</span>
</span><span class='line'>            <span class="n">time_slice</span> <span class="o">=</span> <span class="n">cluster_data</span><span class="p">[:,:,:,</span><span class="n">t_</span><span class="p">]</span>
</span><span class='line'>            <span class="n">time_slice_fut</span> <span class="o">=</span> <span class="n">cluster_data</span><span class="p">[:,:,:,</span><span class="n">t_</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'>            <span class="n">avalanche_id_now</span> <span class="o">=</span> <span class="n">avalanche_id_total</span><span class="p">[:,:,:,</span><span class="n">t_</span><span class="p">]</span>
</span><span class='line'>            <span class="n">avalanche_id_fut</span> <span class="o">=</span> <span class="n">avalanche_id_total</span><span class="p">[:,:,:,</span><span class="n">t_</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'>            <span class="k">for</span> <span class="n">cluster</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">cluster_data</span><span class="p">[:,:,:,</span><span class="n">t_</span><span class="p">])[</span><span class="mi">1</span><span class="p">:]:</span> <span class="c">#iterate over clusters</span>
</span><span class='line'>                <span class="c"># NEW AVALANCHE CASE</span>
</span><span class='line'>                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">time_slice_fut</span><span class="p">[(</span><span class="n">time_slice</span><span class="o">==</span><span class="n">cluster</span><span class="p">)])</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="p">:</span>
</span><span class='line'>                    <span class="n">avalanche_id_now</span><span class="p">[(</span><span class="n">time_slice</span><span class="o">==</span><span class="n">cluster</span><span class="p">)]</span> <span class="o">=</span> <span class="n">avalanche_id_num</span>
</span><span class='line'>
</span><span class='line'>                    <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">time_slice_fut</span><span class="p">[(</span><span class="n">time_slice</span><span class="o">==</span><span class="n">cluster</span><span class="p">)])[</span><span class="mi">1</span><span class="p">:]:</span>
</span><span class='line'>                        <span class="n">avalanche_id_fut</span><span class="p">[(</span><span class="n">time_slice_fut</span><span class="o">==</span><span class="n">value</span><span class="p">)]</span> <span class="o">=</span> <span class="n">avalanche_id_num</span>
</span><span class='line'>
</span><span class='line'>                    <span class="n">avalanche_id_num</span> <span class="o">=</span> <span class="n">avalanche_id_num</span> <span class="o">+</span><span class="mi">1</span>
</span><span class='line'>
</span><span class='line'>                    <span class="n">avalanche_id_total</span><span class="p">[:,:,:,</span><span class="n">t_</span><span class="p">]</span> <span class="o">=</span> <span class="n">avalanche_id_now</span>
</span><span class='line'>                    <span class="n">avalanche_id_total</span><span class="p">[:,:,:,</span><span class="n">t_</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">avalanche_id_fut</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>        <span class="k">elif</span> <span class="n">t_</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">n_t</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>  <span class="c">#if not first timestep, check previous</span>
</span><span class='line'>            <span class="k">print</span> <span class="n">t_</span>
</span><span class='line'>            <span class="c">#time_slice_past = cluster_data[:,:,:,t_-1]</span>
</span><span class='line'>            <span class="n">time_slice</span> <span class="o">=</span> <span class="n">cluster_data</span><span class="p">[:,:,:,</span><span class="n">t_</span><span class="p">]</span>
</span><span class='line'>            <span class="n">time_slice_fut</span> <span class="o">=</span> <span class="n">cluster_data</span><span class="p">[:,:,:,</span><span class="n">t_</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'>            <span class="n">avalanche_id_now</span> <span class="o">=</span> <span class="n">avalanche_id_total</span><span class="p">[:,:,:,</span><span class="n">t_</span><span class="p">]</span>
</span><span class='line'>            <span class="n">avalanche_id_fut</span> <span class="o">=</span> <span class="n">avalanche_id_total</span><span class="p">[:,:,:,</span><span class="n">t_</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'>            <span class="k">for</span> <span class="n">cluster</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">cluster_data</span><span class="p">[:,:,:,</span><span class="n">t_</span><span class="p">])[</span><span class="mi">1</span><span class="p">:]:</span>
</span><span class='line'>                <span class="c"># PREVIOUS AVALANCHE CASE</span>
</span><span class='line'>                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">avalanche_id_now</span><span class="p">[(</span><span class="n">time_slice</span><span class="o">==</span><span class="n">cluster</span><span class="p">)])</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
</span><span class='line'>                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">time_slice_fut</span><span class="p">[(</span><span class="n">time_slice</span><span class="o">==</span><span class="n">cluster</span><span class="p">)])</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="p">:</span>
</span><span class='line'>
</span><span class='line'>                        <span class="n">this_avalanche</span> <span class="o">=</span> <span class="n">avalanche_id_now</span><span class="p">[(</span><span class="n">time_slice</span><span class="o">==</span><span class="n">cluster</span><span class="p">)][</span><span class="mi">0</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'>                        <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">time_slice_fut</span><span class="p">[(</span><span class="n">time_slice</span><span class="o">==</span><span class="n">cluster</span><span class="p">)])[</span><span class="mi">1</span><span class="p">:]:</span>
</span><span class='line'>                            <span class="n">avalanche_id_fut</span><span class="p">[(</span><span class="n">time_slice_fut</span><span class="o">==</span><span class="n">value</span><span class="p">)]</span> <span class="o">=</span> <span class="n">this_avalanche</span>
</span><span class='line'>
</span><span class='line'>                        <span class="n">avalanche_id_total</span><span class="p">[:,:,:,</span><span class="n">t_</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">avalanche_id_fut</span>
</span><span class='line'>
</span><span class='line'>                <span class="c"># NEW AVALANCHE CASE</span>
</span><span class='line'>                <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">avalanche_id_now</span><span class="p">[(</span><span class="n">time_slice</span><span class="o">==</span><span class="n">cluster</span><span class="p">)])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="c">#and np.count_nonzero(time_slice_past[(time_slice==cluster)]) == 0:</span>
</span><span class='line'>                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">time_slice_fut</span><span class="p">[(</span><span class="n">time_slice</span><span class="o">==</span><span class="n">cluster</span><span class="p">)])</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="p">:</span>
</span><span class='line'>
</span><span class='line'>                        <span class="n">avalanche_id_now</span><span class="p">[(</span><span class="n">time_slice</span><span class="o">==</span><span class="n">cluster</span><span class="p">)]</span> <span class="o">=</span> <span class="n">avalanche_id_num</span>
</span><span class='line'>
</span><span class='line'>                        <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">time_slice_fut</span><span class="p">[(</span><span class="n">time_slice</span><span class="o">==</span><span class="n">cluster</span><span class="p">)])[</span><span class="mi">1</span><span class="p">:]:</span>
</span><span class='line'>                            <span class="n">avalanche_id_fut</span><span class="p">[(</span><span class="n">time_slice_fut</span><span class="o">==</span><span class="n">value</span><span class="p">)]</span> <span class="o">=</span> <span class="n">avalanche_id_num</span>
</span><span class='line'>
</span><span class='line'>                        <span class="n">avalanche_id_num</span> <span class="o">=</span> <span class="n">avalanche_id_num</span> <span class="o">+</span> <span class="mi">1</span>
</span><span class='line'>
</span><span class='line'>                        <span class="n">avalanche_id_total</span><span class="p">[:,:,:,</span><span class="n">t_</span><span class="p">]</span> <span class="o">=</span> <span class="n">avalanche_id_now</span>
</span><span class='line'>                        <span class="n">avalanche_id_total</span><span class="p">[:,:,:,</span><span class="n">t_</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">avalanche_id_fut</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>    <span class="n">img_new</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">Nifti1Image</span><span class="p">(</span><span class="n">avalanche_id_total</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="n">img</span><span class="o">.</span><span class="n">get_header</span><span class="p">(),</span> <span class="n">affine</span><span class="o">=</span><span class="n">img</span><span class="o">.</span><span class="n">get_affine</span><span class="p">())</span>
</span><span class='line'>    <span class="c"># Reconstruct the 4D volume</span>
</span><span class='line'>    <span class="n">cond_rm_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span> <span class="s">&#39;avalanche.nii.gz&#39;</span><span class="p">)</span>
</span><span class='line'>    <span class="n">img_new</span><span class="o">.</span><span class="n">to_filename</span><span class="p">(</span><span class="n">cond_rm_file</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="n">avalanche_id_total</span>
</span></code></pre></td></tr></table></div></figure>


<h2><strong> Discussions on Clustering and Avalanche detection </strong></h2>

<h4><strong> Clustering Detection </strong></h4>

<p>After coding the algorithms as explained in the paper, we extended it to some discussion, we found further questions of interest with regard to the algorithm. Questions that have emerged after initial implementation are the following:</p>

<p>I was wondering about the root aspects of defining 1 single neighbour and not more in the clustering detection and also about the decision of determining a cluster just from one neighbouring. Which are the implications of these assumptions? I actually tried the implementation extending the neighbouring adding more neighbours (2 and 3).</p>

<p>I came across with less and bigger clusters, which we discussed for its possible interest specifically with brain images. See images below for clusters with the proposed 1 distance for neighbours and with a distance of 2, at a given time:</p>

<p><img class="center" src="/C-PAC/images/cluster.png" width="800" height="800" title="image" alt="image"></p>

<p>From these approaches we can have some statistics, showing that the choice of the number of neighbours to consider is not a trivial decision:</p>

<p><img class="center" src="/C-PAC/images/cluster_stats.png" width="800" height="800" title="image" alt="image"></p>

<h4><strong> Avalanche Detection </strong></h4>

<p>We collected all the avalanches for a given subject in a 4D Nifti file. Avalanches were significantly different depending of the choice of the neighbouring size (due to the change of the size of the mean cluster). Here we show a first approximation, we would have liked to make a movie, but we ran out of time for this week.</p>

<p><img class="center" src="/C-PAC/images/avalanche.gif" width="800" height="800" title="image" alt="image"></p>

<p>Here I have made a gif to represent how an avalanche is. This is an avalanche for the N2 cluster, take into account just the voxels in red/orange. It can be showed how the avalanche borns, grows and spreads, and finally dies.</p>

<h2><strong> Heading last week of coding </strong></h2>

<p>Our objectives for next week are:</p>

<ul>
<li><p>Perform extensive testing over the measures and chose which ones are going to be in the package.</p></li>
<li><p>Make code corrections and comment all the measures. This will head us into the documentation we have to make.</p></li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/C-PAC/blog/2015/08/07/integration-of-measures-and-point-process-developing/">Integration of Measures and Point Process Developing</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-08-07T08:26:14+02:00'><span class='date'><span class='date-month'>Aug</span> <span class='date-day'>7</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>8:26 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>We are heading the end of the quarter and our toolbox is starting to be mature, while we investigate the many links and uses between tools. This week we have gone through important steps (but at the same time ongoing discussions due to the rich materials produced at this stage). Two main new things we have done, beyond the polishing of previous tools and validating ongoing:</p>

<ul>
<li><p>The integration of the toolbox in CPAC&rsquo;s pipeline is almost complete. This has been a tough task to do, since the internals of CPAC are quite large, with many flows and structures, but the main idea is clear: The work to do is to link the inputs you get from the GUI and the data already calculated previously in other CPAC&rsquo;s modules with your workflows inputs and integrate them in the main pipeline.</p></li>
<li><p>Point Process Analysis and Conditional Rate Maps calculation: Following the initial plan, we have developed some new methods to test the time scale side of the toolbox and while Supraja is progressing with multifractal analysis in parallel.</p></li>
</ul>


<p>Following the instructions in the paper of <a href="http://journal.frontiersin.org/article/10.3389/fphys.2012.00015/abstract">Tagliazucchi et al</a> (&ldquo;<em>Criticality in large-scale brain fMRI dynamics unveiled by a novel point process analysis</em>&rdquo;), we have been able to code the base point process approach followed of a Conditional Rate Map building as in the paper.</p>

<p>And last, in terms of toolbox integration, new cross relationships have been looked at. Some of those are portrayed from our last model:</p>

<p><img class="center" src="/C-PAC/images/GUI_Diagram2.png" width="600" height="600" title="image" alt="image"></p>

<h2><strong> Integration of the toolbox in CPAC&rsquo;s pipeline  </strong></h2>

<p>After carefully having explored the main pipeline, we realized that in order to not to repeat code and structures that are already developed, I had to make some changes in my initial workflows. At the beginning of the project, I coded them as independent workflows, with independent behaviour and inputs, and some helper functions that are already integrated in CPAC but that where necessary for me in that moment. Now, I have to link the data that would be already in CPAC, change the treatment of the inputs of my workflows and integrate them as a single tool.</p>

<p>That will have effect too in the configuration of the GUI I proposed two weeks ago, being now more efficient. We have now all measures in a joint page of the GUI, having separated each of the main boxes of the initial plan in three different checkboxes with a common input. Also, the input data for my workflows will come from the TSE module of CPAC, which already makes these extractions. I have to modify my functions to work with 1D files (I have already the main code block built, since I already treated with this data type in the analysis of the 400 regions).</p>

<p>In the main pipeline, I have inserted the NLTSA workflow:</p>

<p><a href="https://github.com/roijo/C-PAC_complexitytools/blob/master/CPAC/pipeline/cpac_pipeline.py#L3207-L3368">https://github.com/roijo/C-PAC_complexitytools/blob/master/CPAC/pipeline/cpac_pipeline.py#L3207-L3368</a></p>

<p>It can be seen in the code that still are many things to change and improve, I am receiving crucial help from developers, to fully understand how the main pipeline works and transferring this knowledge to all discussions.</p>

<p>The main structure at the moment, is a three block structure as previously proposed, plus the insert of qualities that measures derived from ergodic theory rely on. From these, I let the user to choose which one of them (the measures inside each of them) to calculate. I will change my workflows (I will have one per measure-box) and inside them, the measures will be called directly depending if they have been chosen by the user or not.</p>

<h2><strong> Point Process Analysis and Conditional Rate Maps </strong></h2>

<p>The technique can be easily described, extracted from the section  <em>Methods</em> of the paper:</p>

<p><em>The point process is defined by the sequences of time points at which the BOLD signal crosses a given threshold from below. (&hellip;) To construct the conditional rates the point process is defined at a seed location and at the targets throughout the entire brain. The BOLD signal is extracted from a seed region (top trace) and the points (arrows and vertical dashed lines) are defined by the crossings at 1 SD (horizontal dashed lines). Every time the signal at a target region crosses the threshold (asterisks) up to 2 time steps later than in the seed, the rate at the target is increased in one unit. This rate is normalized by the number of points in the seed. The top panel shows the location of the seed and of the two example targets, as well as the resulting average conditional rates maps (left) and DMN obtained from PICA (right). Medium panels show the BOLD signal at the seed and at the two example target regions.</em></p>

<p><img class="center" src="http://www.frontiersin.org/files/Articles/20422/fphys-03-00015-r2/image_m/fphys-03-00015-g006.jpg" width="600" height="600" title="image" alt="image"></p>

<p>From that explanation a pair of functions have been developed:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='py'><span class='line'><span class="c"># Point process analysis for a signal. Values equal to 1 when the original value </span>
</span><span class='line'><span class="c"># is higher than the threshold (1*SD)</span>
</span><span class='line'><span class="k">def</span> <span class="nf">point_process</span><span class="p">(</span><span class="n">signal</span><span class="p">):</span>
</span><span class='line'>
</span><span class='line'>    <span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">pp_signal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span class='line'>    <span class="n">th</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">signal</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">pp_signal</span><span class="p">[</span><span class="n">signal</span> <span class="o">&gt;</span> <span class="n">th</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="n">pp_signal</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
</pre></td><td class='code'><pre><code class='py'><span class='line'><span class="c"># Conditional Rate Map. Given an fMRI, extract timeseries, calculate Point Process</span>
</span><span class='line'><span class="c"># and then the Rate Map for each voxel given a seed   </span>
</span><span class='line'><span class="k">def</span> <span class="nf">cond_rm</span><span class="p">(</span><span class="n">in_file</span><span class="p">,</span> <span class="n">seed_location</span><span class="p">):</span>
</span><span class='line'>
</span><span class='line'>    <span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
</span><span class='line'>    <span class="kn">import</span> <span class="nn">os</span>
</span><span class='line'>    <span class="kn">import</span> <span class="nn">nibabel</span> <span class="kn">as</span> <span class="nn">nb</span>
</span><span class='line'>
</span><span class='line'>    <span class="c"># Treat fMRI image</span>
</span><span class='line'>    <span class="n">img</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">in_file</span><span class="p">)</span>
</span><span class='line'>    <span class="c">#print img.shape</span>
</span><span class='line'>    <span class="n">data</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>    <span class="p">(</span><span class="n">n_x</span><span class="p">,</span> <span class="n">n_y</span><span class="p">,</span> <span class="n">n_z</span><span class="p">,</span> <span class="n">n_t</span><span class="p">)</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">K</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_x</span><span class="p">,</span> <span class="n">n_y</span><span class="p">,</span> <span class="n">n_z</span><span class="p">))</span>
</span><span class='line'>    <span class="c"># Extract seed and pp</span>
</span><span class='line'>    <span class="n">seed_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">seed_location</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">seed_location</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">seed_location</span><span class="p">[</span><span class="mi">2</span><span class="p">],:]</span>
</span><span class='line'>    <span class="n">pp_seed_data</span> <span class="o">=</span> <span class="n">point_process</span><span class="p">(</span><span class="n">seed_data</span><span class="p">)</span>
</span><span class='line'>    <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">pp_seed_data</span><span class="p">)</span>
</span><span class='line'>    <span class="c"># Calculate each PP signal</span>
</span><span class='line'>    <span class="k">for</span> <span class="n">i_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_x</span><span class="p">):</span>
</span><span class='line'>        <span class="k">for</span> <span class="n">j_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_y</span><span class="p">):</span>
</span><span class='line'>            <span class="k">for</span> <span class="n">k_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_z</span><span class="p">):</span>
</span><span class='line'>
</span><span class='line'>                <span class="n">target_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">i_</span><span class="p">,</span><span class="n">j_</span><span class="p">,</span><span class="n">k_</span><span class="p">,:]</span>
</span><span class='line'>                <span class="n">pp_target_data</span> <span class="o">=</span> <span class="n">point_process</span><span class="p">(</span><span class="n">target_data</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>                <span class="c"># LOGIC AND (target/seed) and count(signal == 1), that will give you the X/r parameter [0,1]</span>
</span><span class='line'>                <span class="n">K</span><span class="p">[</span><span class="n">i_</span><span class="p">,</span><span class="n">j_</span><span class="p">,</span><span class="n">k_</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">pp_seed_data</span><span class="p">,</span><span class="n">pp_target_data</span><span class="p">))</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="c"># Reconstruct the 3D volume</span>
</span><span class='line'>    <span class="n">cond_rm_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span> <span class="s">&#39;cond_rm.nii.gz&#39;</span><span class="p">)</span>
</span><span class='line'>    <span class="n">img</span><span class="o">.</span><span class="n">to_filename</span><span class="p">(</span><span class="n">cond_rm_file</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="n">cond_rm_file</span>
</span></code></pre></td></tr></table></div></figure>


<p>As it can be seen, there is still a small change to be done in the CRM function. As described in the paper, the target point processed signal has to be checked in the same time point as the seed and up to 2 time steps later. As it can be derived from the image, is takes all the values crossing the threshold in a row just as one crossing. I would like to keep my function in a pythonic way and I don&rsquo;t find a way of computing the CRM without messing everything up with index checking to satisfy the requirements of the algorithm. Also, it would be desirable to know if the data already satisfies the requirements of z-scoring and HRF deconvolution as proposed in the paper and if this has effect on the algorithm results.</p>

<p>From these calculations, we can start extracting volumes such as:</p>

<p><img class="center" src="/C-PAC/images/CRM.png" width="800" height="800" title="image" alt="image"></p>

<p>We are now discussing about the possibility of following the analysis by building the Clustering and the Avalanche detection, but they are not as well described in the paper and we have to make a evaluation of the time we have to finish the project.</p>

<h2><strong> Relation between Correlation and CMR&rsquo;s number of point-wise events </strong></h2>

<p>To make a comparison between the number of points that are necessary to reach a specific information level with the point process algorithm, we have used the correlation to identify highly synchronized timeseries. What we have done here is to build a relation between the synchrony of two variables and the point peaks that share each other after point processing them (CMR without normalizing).</p>

<p>As an initial optimization we can find to which level point process transients can be translated to a point of criticality. This analysis has been produced at the voxel-wise level from ABIDE subjects, properly checked and preprocessed. Here, we can see how the increasing of the (mean) synchrony between two variables, increases the points that they share. This is a really nice finding, because it shows how point process can describe the change of regime associated with functional connectivity.</p>

<p><img class="center" src="/C-PAC/images/corr_vs_points.png" width="400" height="400" title="image" alt="image"></p>

<p>We can observe how once reached a threshold of 0.7 correlation point-processes can saturate giving a new quality to connectivity between regions.</p>

<h2><strong> Others </strong></h2>

<ul>
<li><p>Even if the VAR model calculation was corrected in the previous week, there was still an issue
with the calculation of <em>pwcgc()</em> , the internal loop has been already corrected. We have tested the function over data and looks to have the same performance as the original Matlab function. Different distributions of these will be last discussed if we can define more optimal models.</p></li>
<li><p>We have been discussing about the need of visualization of some analysis inside and some statistics  CPAC (Pandas integration) . This is maybe a sore point that would be better to discuss with main developers.</p></li>
<li><p>Next week we will follow our work with the integration, enforcement of criticality package and also we are into final integration of all our measures (phase measures integration with Scale Free Dynamics ones like DFA/Hurst exponent, for example).</p></li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/C-PAC/blog/2015/07/22/discussion-and-planning-gui-for-nltsa-and-testing-synchrony-measures/">Discussion and Planning GUI for NLTSA and Testing Synchrony Measures</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-07-22T12:24:57+02:00'><span class='date'><span class='date-month'>Jul</span> <span class='date-day'>22</span><span class='date-suffix'>nd</span>, <span class='date-year'>2015</span></span> <span class='time'>12:24 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>We are trying to converge to an easy and clear design of the GUI of our toolbox that integrates in CPAC’s structure and allows users to use it. We are trying here to avoid redundant options in the workflow and it is becoming a quite difficult task, since we want the measures to be separated in differentiated subgroups, but at the same time, give the toolbox the possibility of using common functions (such as the extraction of the timeseries). It has to be non-redundant in this way, the most complicated thing will be the correct use of data structures (to take the ones that are already being generated from other modules in CPAC and to check if the series of a volume had been already extracted, in order to do not duplicate efforts). The design has to be generalizable enough that it can be used in other workflows.</p>

<h2><strong> Planning of the GUI for NLTSA module  </strong></h2>

<p>As the most important part of developing new software, it is always necessary to have a good developing plan. For the purpose of building the GUI for our toolbox, we have divided all our measures in 3 main groups:</p>

<ul>
<li>Pre-Analysis measures: The ones that not correspond directly to NonLinearTimeSeriesAnalysis and can be applied directly into the extracted data. We can find here synchrony measures in time (correlation, partial correlation) and frequency domain (phase synchrony index, phase locking value). Also, treatment of fingerprints and ICA timeseries extraction are due to be added in this submodule.</li>
<li>Information Theory and Causality measures: The ones coming from the informative framework and causality. These measures involve the acquisition of information flow and sharing between variables (Mutual Information, Transfer Entropy, Granger Causality Toolbox measures (MVGC, PWCGC)).</li>
<li>Scale free dynamics measures: This is the box that make use of the most advanced measures (fractality, avalanches, detrended fluctuation analysis, Hurst exponents). These measures are still pending of being developed (planned for August), so we have still not decided about the inputs and the outputs they are generating.</li>
</ul>


<p>The schema shown above has been resumed in the next diagram. Most of the modules make use of other modules functions (we have tried to not being redundant with CPAC’s code). We have ensured that the helper functions developed for our toolbox are available also from outside our module.</p>

<p><img class="center" src="/C-PAC/images/GUI_Diagram.png" width="800" height="800" title="image" alt="image"></p>

<h2><strong> Implementation of the GUI </strong></h2>

<p>Following the instructions published in the previous post, there has been straightforward to build up the 3 subgroups, as they are quite similar between each other. The most important feature for us was the possibility of calculating the measures independently (there is no need of calculating all of them, the user can choose whether to apply the different measures without restriction).</p>

<p><img class="center" src="/C-PAC/images/CPAC_GUI_1.png" width="800" height="800" title="image" alt="image"></p>

<p><img class="center" src="/C-PAC/images/CPAC_GUI_2.png" width="800" height="800" title="image" alt="image"></p>

<p><img class="center" src="/C-PAC/images/CPAC_GUI_3.png" width="800" height="800" title="image" alt="image"></p>

<p>A serious work must be done in flow-controlling inside <em>cpac_pipeline.py</em> to avoid repeating the operations present in the submodules (mainly, timeseries generation. Once that are generated, there is no point in extracting them again). Also, it is important to have well connected the toolbox to the main CPAC’s workflow and check whether the data has been previously extracted. Maybe we can talk at some point soon about this and listen to developers thoughts, comments in the post will be very welcomed. Also, we left the door open for interesting modifications that could happen (the 3rd submodule is still pending of being coded and we have in mind to deal with visualization and data presentation). The whole integration will be held in the last week of GSoC with the help of all collaborators and students.</p>

<h2><strong> Synchrony measures in ADHD data </strong></h2>

<p>As we are trying not to evaluate all our measures together at the end, this week we have tried extensively our new dataset from ADHD200 (specific information about the dataset and how we  did our first experiment in <a href="http://erramuzpe.github.io/C-PAC/blog/2015/07/09/testing-different-parcellations-over-ad-patients-data/">previous post</a> ).</p>

<p>We had two measures to test over this data, “phase synchrony index” (which is a self-informative value about the synchrony level of a specific signal) and “phase locking value” (which is the relation between the synchronicity of 2 variables).</p>

<p>We had two measures to test over this data, “phase synchrony index” or PSI (which is a self-informative value about the synchrony level of a specific signal) and “phase locking value” or PLV (which is the relation between the synchronicity of 2 variables).</p>

<h4><strong> Results </strong></h4>

<p>The PSI is a single variable measure, so it is just an self-informative measure. First results showed that the data extracted with the cc400 and cc1000 parcellations had a low synchrony level (some of them looked totally desynchronized). Overall, there was not much to say about differences between ADHD patients and controls.</p>

<p>The PLV, however, showed that the synchrony between some of the signals was strong (>0.7). As these parcellations are randomly created and assigned, consecutive ROIs have not spatial relation and showing the usual matrixes was not going to be informative.</p>

<h2><strong> Solved GC VAR model calculation </strong></h2>

<p>We have changed the paradigm of measuring the residuals for the Granger Causality calculation. Instead of calculating the covariance matrix of the data, which was creating problems later with the VAR model, we have change this. Now, the residuals are calculated directly from the data (the regression model used was OLS using QR decomposition. Specifications in MVGC toolbox docs), without performing the calculation of the covariance matrix.</p>

<p>We performed a small evaluation of the PWGC over our ADHD200 dataset and results were not visually different between groups. We are working in an appropriate way of showing results coming from these measures.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/C-PAC/blog/2015/07/15/implementing-modules-in-the-gui/">Implementing Modules in CPAC&#8217;s GUI</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-07-15T12:24:57+02:00'><span class='date'><span class='date-month'>Jul</span> <span class='date-day'>15</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>12:24 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>This week I have been trying to work with the migration of our modules to the GUI. For that, you will need to perform three main steps:</p>

<ul>
<li>Create the interface for your modules (2 steps)

<ul>
<li>Define your space in the main configuration window tree. (Name your module/submodules)</li>
<li>Define a window with configuration options (inputs and output of your workflow basically) for each one of your modules/submodules. The main window of the module usually is referred to an html file explaining what this module does and how does it work.</li>
</ul>
</li>
<li>Link the GUI with your workflows (1 step)

<ul>
<li>Link the configuration window of each of the submodules with the corresponding workflow through the pipeline module, allowing the execution of your workflows.</li>
</ul>
</li>
</ul>


<h2><strong> Create the interface for your modules </strong></h2>

<h4><strong> STEP 1 </strong></h4>

<p>The interface for the modules needs to be created. This is done by adding your module structure to the main configuration tree (a bit of planification is needed before deciding how the module structure is going to be organized). The first 2 steps should be done in parallel, I choosed to create the tree structure first, because I thought it was better a up to bottom approach.</p>

<p>First of all, you have to define your space in the <a href="https://github.com/FCP-INDI/C-PAC/blob/master/CPAC/GUI/interface/windows/config_window.py">config_window</a> file, in the Class named &lsquo;Mybook&rsquo;.</p>

<p>There, you can find all the module names that will be listed in the main left of the pipeline configuration window. As an example, I have added some lines at the end of the Class:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='py'><span class='line'>   <span class="bp">self</span><span class="o">.</span><span class="n">AddPage</span><span class="p">(</span><span class="n">page43</span><span class="p">,</span> <span class="s">&quot;CWAS&quot;</span><span class="p">,</span> <span class="n">wx</span><span class="o">.</span><span class="n">ID_ANY</span><span class="p">)</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">AddSubPage</span><span class="p">(</span><span class="n">page44</span><span class="p">,</span> <span class="s">&quot;CWAS Settings&quot;</span><span class="p">,</span> <span class="n">wx</span><span class="o">.</span><span class="n">ID_ANY</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">AddPage</span><span class="p">(</span><span class="n">page45</span><span class="p">,</span> <span class="s">&quot;Group Analysis&quot;</span><span class="p">,</span> <span class="n">wx</span><span class="o">.</span><span class="n">ID_ANY</span><span class="p">)</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">AddSubPage</span><span class="p">(</span><span class="n">page46</span><span class="p">,</span> <span class="s">&quot;Group Analysis Settings&quot;</span><span class="p">,</span> <span class="n">wx</span><span class="o">.</span><span class="n">ID_ANY</span><span class="p">)</span>
</span><span class='line'>        <span class="c">### ADDED NEXT 3 LINES: 48 is my main module name. 49 and 50 submodules inside 48</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">AddPage</span><span class="p">(</span><span class="n">page48</span><span class="p">,</span> <span class="s">&quot;Non Linear TS Analysis&quot;</span><span class="p">,</span> <span class="n">wx</span><span class="o">.</span><span class="n">ID_ANY</span><span class="p">)</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">AddSubPage</span><span class="p">(</span><span class="n">page49</span><span class="p">,</span> <span class="s">&quot;Information Theory&quot;</span><span class="p">,</span> <span class="n">wx</span><span class="o">.</span><span class="n">ID_ANY</span><span class="p">)</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">AddSubPage</span><span class="p">(</span><span class="n">page50</span><span class="p">,</span> <span class="s">&quot;Causality&quot;</span><span class="p">,</span> <span class="n">wx</span><span class="o">.</span><span class="n">ID_ANY</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>It is also important to add the name of your GUI Classes in the import at the beginning of the file. In the second step, these Classes will be defined.</p>

<h4><strong> STEP 2 </strong></h4>

<p>In this step the Classes that create your configuration pages must be created. Here, it will be defined a window with configuration options (inputs and output of your workflow basically) for each one of your modules/submodules. For this purpose, it is neccessary to create a new file in the <a href="https://github.com/FCP-INDI/C-PAC/tree/master/CPAC/GUI/interface/pages">&lsquo;pages&rsquo; directory</a>, other files can be used an example.</p>

<p>The main window of the module (in our example the 48) is usually referred to an html file explaining what this module does and how does it work. If you don&rsquo;t have such file yet, you can leave it blank. For the rest of submodules, as CPAC&rsquo;s has its own framework built over <a href="http://www.wxpython.org/">wx</a>, we can choose between many specific buttons and data tpyes to add to our window:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='py'><span class='line'><span class="n">control</span> <span class="o">=</span> <span class="n">enum</span><span class="p">(</span><span class="n">CHOICE_BOX</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
</span><span class='line'>               <span class="n">TEXT_BOX</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
</span><span class='line'>               <span class="n">COMBO_BOX</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
</span><span class='line'>               <span class="n">INT_CTRL</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
</span><span class='line'>               <span class="n">FLOAT_CTRL</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
</span><span class='line'>               <span class="n">DIR_COMBO_BOX</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
</span><span class='line'>               <span class="n">CHECKLIST_BOX</span> <span class="o">=</span> <span class="mi">6</span><span class="p">,</span>
</span><span class='line'>               <span class="n">LISTBOX_COMBO</span> <span class="o">=</span> <span class="mi">7</span><span class="p">,</span>
</span><span class='line'>               <span class="n">TEXTBOX_COMBO</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
</span><span class='line'>               <span class="n">CHECKBOX_GRID</span> <span class="o">=</span> <span class="mi">9</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">dtype</span> <span class="o">=</span> <span class="n">enum</span><span class="p">(</span><span class="n">BOOL</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
</span><span class='line'>             <span class="n">STR</span><span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
</span><span class='line'>             <span class="n">NUM</span><span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
</span><span class='line'>             <span class="n">LBOOL</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
</span><span class='line'>             <span class="n">LSTR</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
</span><span class='line'>             <span class="n">LNUM</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
</span><span class='line'>             <span class="n">LOFL</span> <span class="o">=</span> <span class="mi">6</span><span class="p">,</span>
</span><span class='line'>             <span class="n">COMBO</span> <span class="o">=</span> <span class="mi">7</span><span class="p">,</span>
</span><span class='line'>             <span class="n">LDICT</span><span class="o">=</span> <span class="mi">8</span> <span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>This is an example of how it can be a GUI frame for our toolbox:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
</pre></td><td class='code'><pre><code class='py'><span class='line'><span class="k">class</span> <span class="nc">InformationTheory</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">ScrolledWindow</span><span class="p">):</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">):</span>
</span><span class='line'>        <span class="n">wx</span><span class="o">.</span><span class="n">ScrolledWindow</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">)</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">counter</span> <span class="o">=</span> <span class="n">counter</span>
</span><span class='line'>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">page</span> <span class="o">=</span> <span class="n">GenericClass</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&quot;Information Theory Calculation Options&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">page</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s">&quot;Run Information Theory Measures&quot;</span><span class="p">,</span>
</span><span class='line'>                 <span class="n">control</span><span class="o">=</span><span class="n">control</span><span class="o">.</span><span class="n">CHOICE_BOX</span><span class="p">,</span>
</span><span class='line'>                 <span class="n">name</span><span class="o">=</span><span class="s">&#39;runIT&#39;</span><span class="p">,</span>
</span><span class='line'>                 <span class="nb">type</span><span class="o">=</span><span class="n">dtype</span><span class="o">.</span><span class="n">LSTR</span><span class="p">,</span>
</span><span class='line'>                 <span class="n">comment</span><span class="o">=</span><span class="s">&quot;Run Information Theory Measures&quot;</span><span class="p">,</span>
</span><span class='line'>                 <span class="n">values</span><span class="o">=</span><span class="p">[</span><span class="s">&quot;Off&quot;</span><span class="p">,</span><span class="s">&quot;On&quot;</span><span class="p">],</span>
</span><span class='line'>                 <span class="n">wkf_switch</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">page</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s">&quot;Voxelwise / ROI extraction&quot;</span><span class="p">,</span>
</span><span class='line'>                 <span class="n">control</span><span class="o">=</span><span class="n">control</span><span class="o">.</span><span class="n">CHOICE_BOX</span><span class="p">,</span>
</span><span class='line'>                 <span class="n">name</span><span class="o">=</span><span class="s">&#39;voxel_roi&#39;</span><span class="p">,</span>
</span><span class='line'>                 <span class="nb">type</span><span class="o">=</span><span class="n">dtype</span><span class="o">.</span><span class="n">LSTR</span><span class="p">,</span>
</span><span class='line'>                 <span class="n">comment</span><span class="o">=</span><span class="s">&quot;Run Information Theory Measures voxelwise or after ROI timeseries             extraction&quot;</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="p">[</span><span class="s">&quot;Voxelwise&quot;</span><span class="p">,</span><span class="s">&quot;ROI&quot;</span><span class="p">,</span><span class="s">&quot;Voxelwise/ROI&quot;</span><span class="p">],</span>
</span><span class='line'>                 <span class="n">wkf_switch</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">page</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s">&quot;fMRI image&quot;</span><span class="p">,</span>
</span><span class='line'>                     <span class="n">control</span><span class="o">=</span><span class="n">control</span><span class="o">.</span><span class="n">COMBO_BOX</span><span class="p">,</span>
</span><span class='line'>                     <span class="n">name</span><span class="o">=</span><span class="s">&#39;input_image&#39;</span><span class="p">,</span>
</span><span class='line'>                     <span class="nb">type</span><span class="o">=</span><span class="n">dtype</span><span class="o">.</span><span class="n">STR</span><span class="p">,</span>
</span><span class='line'>                     <span class="n">comment</span><span class="o">=</span><span class="s">&quot;fMRI image for calculation&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">page</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s">&quot;Parcellation Mask&quot;</span><span class="p">,</span>
</span><span class='line'>                     <span class="n">control</span><span class="o">=</span><span class="n">control</span><span class="o">.</span><span class="n">COMBO_BOX</span><span class="p">,</span>
</span><span class='line'>                     <span class="n">name</span><span class="o">=</span><span class="s">&#39;input_mask&#39;</span><span class="p">,</span>
</span><span class='line'>                     <span class="nb">type</span><span class="o">=</span><span class="n">dtype</span><span class="o">.</span><span class="n">STR</span><span class="p">,</span>
</span><span class='line'>                     <span class="n">comment</span><span class="o">=</span><span class="s">&quot;Parcellation Mask if you want to calculate&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">page</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">label</span> <span class="o">=</span> <span class="s">&quot;Measures:&quot;</span><span class="p">,</span>
</span><span class='line'>                      <span class="c">#control = control.CHECKLISTBOX_COMBO,</span>
</span><span class='line'>                      <span class="n">control</span> <span class="o">=</span> <span class="n">control</span><span class="o">.</span><span class="n">LISTBOX_COMBO</span><span class="p">,</span>
</span><span class='line'>                      <span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Measures&quot;</span><span class="p">,</span>
</span><span class='line'>                      <span class="nb">type</span> <span class="o">=</span> <span class="n">dtype</span><span class="o">.</span><span class="n">LDICT</span><span class="p">,</span>
</span><span class='line'>                      <span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;Entropy&#39;</span><span class="p">,</span> <span class="s">&#39;Conditional Entropy&#39;</span><span class="p">,</span><span class="s">&#39;Mutual Information&#39;</span><span class="p">,</span><span class="s">&#39;Transfer Entropy&#39;</span><span class="p">,</span><span class="s">&#39;Entropy Correlation Coefficient&#39;</span><span class="p">],</span>
</span><span class='line'>                      <span class="n">comment</span> <span class="o">=</span> <span class="s">&quot;Select which IT measures to apply:</span><span class="se">\n</span><span class="s">&quot;</span>\
</span><span class='line'>                                <span class="s">&quot;ent = Entropy</span><span class="se">\n</span><span class="s">&quot;</span>\
</span><span class='line'>                                 <span class="s">&quot;condent = Conditional Entropy</span><span class="se">\n</span><span class="s">&quot;</span>\
</span><span class='line'>                                 <span class="s">&quot;mi = Mutual Information</span><span class="se">\n</span><span class="s">&quot;</span>\
</span><span class='line'>                                 <span class="s">&quot;te = Transfer Entropy</span><span class="se">\n</span><span class="s">&quot;</span>\
</span><span class='line'>                                 <span class="s">&quot;ecc = Entropy Correlation Coefficient</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
</span><span class='line'>                     <span class="n">size</span> <span class="o">=</span> <span class="p">(</span><span class="mi">300</span><span class="p">,</span><span class="mi">120</span><span class="p">),</span>
</span><span class='line'>                     <span class="n">combo_type</span> <span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">page</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s">&quot;Output Options &quot;</span><span class="p">,</span>
</span><span class='line'>                      <span class="n">control</span><span class="o">=</span><span class="n">control</span><span class="o">.</span><span class="n">CHECKLIST_BOX</span><span class="p">,</span>
</span><span class='line'>                      <span class="n">name</span><span class="o">=</span><span class="s">&quot;measure_options&quot;</span><span class="p">,</span>
</span><span class='line'>                      <span class="nb">type</span><span class="o">=</span><span class="n">dtype</span><span class="o">.</span><span class="n">LBOOL</span><span class="p">,</span>
</span><span class='line'>                      <span class="n">values</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;CSV&#39;</span><span class="p">,</span> <span class="s">&#39;NUMPY&#39;</span><span class="p">,</span><span class="s">&#39;NIFTI&#39;</span><span class="p">],</span>
</span><span class='line'>                      <span class="n">comment</span><span class="o">=</span><span class="s">&quot;By default, results are written as NIFTI files. Additional output formats are as a .csv spreadsheet or a Numpy array.&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">page</span><span class="o">.</span><span class="n">set_sizer</span><span class="p">()</span>
</span><span class='line'>        <span class="n">parent</span><span class="o">.</span><span class="n">get_page_list</span><span class="p">()</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>It is important to update the <strong>init</strong> file of the folder &lsquo;pages&rsquo; to make the new file available and checking all the intermodule dependencies and imports.
After doing these modifications, the modifications will be seen as long as the <a href="https://github.com/FCP-INDI/C-PAC/blob/master/CPAC/GUI/mainUI.py">MainUI</a> file runs without problem.</p>

<p>In the next figure, it can be seen how the example code is translated into the GUI:</p>

<p><img class="center" src="/C-PAC/images/CPAC_GUI.png" width="800" height="800" title="image" alt="image"></p>

<p>After completing your configuration, a YAML file will be created with the information provided into the different inputs.</p>

<h2><strong> Link the GUI with your workflows </strong></h2>

<h4><strong> STEP 3 </strong></h4>

<p>This is probably the most important step along with having a good planification of the needs of the module. The objective here is to link the configuration window of each of the submodules with the corresponding workflow through the pipeline module and specifically the <a href="https://github.com/FCP-INDI/C-PAC/blob/master/CPAC/pipeline/cpac_pipeline.py">cpac_pipeline</a> file, allowing the execution of your workflows.</p>

<p>First of all, it is needed to import the workflows into the file. After that, and having as a reference other workflow insertions, you can take the input data saved in the previous step from a <a href="https://github.com/FCP-INDI/C-PAC/blob/master/CPAC/utils/configuration.py">Configuration object</a> called &lsquo;c&rsquo;. This ‘c’ variable is an abstract representation used to store the options for the pipeline configuration YAML. The use of the YAML file, allows users to load preconfigured files easily.
The YAML was generated by the GUI in the previous step and it is reloaded back in by <a href="https://github.com/FCP-INDI/C-PAC/blob/afbc30e28e4c282847920119e922953690835d36/CPAC/pipeline/cpac_runner.py#L381">cpac_runner</a>  as a Configuration object (‘c’).  Finally, <em>cpac_runner.py</em> passes the Configuration object to <em>cpac_pipeline.py</em> as an argument.</p>

<p>There is the need of checking if the inputs are correct (otherwise, raise an error message), create the workflow and give to it the inputs extracted from &lsquo;c&rsquo;.
<em>cpac_pipeline.py</em> is where the Nipype workflow object for each pipeline strategy is constructed via flow control. We will want to add a code block similar to <a href="https://github.com/FCP-INDI/C-PAC/blob/master/CPAC/pipeline/cpac_pipeline.py#L3028-L3197">this</a>  in order to add the nonlinear time-series node to these workflows.  The functions will be encapsulated within nodes and connected to a workflow.</p>

<p>Short example of how to manage the inputs:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='py'><span class='line'>    <span class="sd">&#39;&#39;&#39;</span>
</span><span class='line'><span class="sd">    Inserting NLTSA</span>
</span><span class='line'><span class="sd">    Workflow</span>
</span><span class='line'><span class="sd">    &#39;&#39;&#39;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">new_strat_list</span> <span class="o">=</span> <span class="p">[]</span>
</span><span class='line'>    <span class="n">num_strat</span> <span class="o">=</span> <span class="mi">0</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="mi">1</span> <span class="ow">in</span> <span class="n">c</span><span class="o">.</span><span class="n">runIT</span><span class="p">:</span>
</span><span class='line'>        <span class="k">for</span> <span class="n">strat</span> <span class="ow">in</span> <span class="n">strat_list</span><span class="p">:</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span> <span class="s">&#39;mi&#39;</span> <span class="ow">in</span> <span class="n">c</span><span class="o">.</span><span class="n">MEASURES</span>
</span><span class='line'>
</span><span class='line'>            <span class="n">pipeline</span> <span class="o">=</span> <span class="n">create_mi</span><span class="p">()</span>
</span><span class='line'>            <span class="n">pipeline</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">inputspec</span><span class="o">.</span><span class="n">in_file</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">input_image</span>
</span><span class='line'>            <span class="n">pipeline</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">inputspec</span><span class="o">.</span><span class="n">mask_file</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">input_mask</span>
</span><span class='line'>            <span class="n">pipeline</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>            <span class="n">num_strat</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span class='line'>    <span class="n">strat_list</span> <span class="o">+=</span> <span class="n">new_strat_list</span>
</span></code></pre></td></tr></table></div></figure>


<p>After completing this last step, the new module of CPAC should be working.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/C-PAC/blog/2015/07/09/testing-different-parcellations-over-ad-patients-data/">Testing Over ADHD Patients Data</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-07-09T11:23:22+02:00'><span class='date'><span class='date-month'>Jul</span> <span class='date-day'>9</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>11:23 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>This week we have been clarifying the issues involved on MVGC’s statistical model. Namely, the model to calculate the residuals that we use to measure the causality could be interpreted in a different way that we need to have well settled. Once we have identified the problem and clarified how this model should better be, we will shortly readdress and implement the experimentation done.</p>

<h4>Testing on real datasets</h4>

<p>We did our first systematic efforts to test workflows integrally with fMRI data and find if the results were coherent with the technique.</p>

<h5>Materials and methods:</h5>

<ul>
<li>Data was used from the <a href="http://neurobureau.projects.nitrc.org/ADHD200/Introduction.html">ADHD200 initiative</a> as recommended . For this purpose, I selected the preprocessed NeuroImage dataset (4mm voxel size).</li>
<li>Data sampling: After having downloaded the data, we ruled out several subjects from the study (left handed&hellip;), resulting in 34 total subjects and then they were classified in 2 main groups: Controls and ADHD patients (20/14).</li>
<li>Image processing: I extracted the mean timeseries of this data using the cc400 and cc1000 masks and performed a test analysis. Corr, TE and MI  were computed over the series. Here I show resulting matrixes for the cc400 parcellation (results for cc1000 were similar).</li>
</ul>


<p><img class="right" src="/C-PAC/images/AD_400.png" width="400" height="400" title="image" alt="image"></p>

<p>First numbers showed than calculating the mean CC, TE and MI matrices for each group, most of the measures were close to 0. The results for the 1000 ROI parcellation was similar. This is a behaviour that it was also shown for the YALE preprocessed subsample (ABIDE) that we have been using in previous attempts for these high parcellated masks.</p>

<p>We tried a similar approach with the data already extracted for cc400 and TT parcellations and while cc400 showed same results as our self-extracted series (we can say that our extraction method works fine) the TT parcellated data showed the following structures:</p>

<p><img class="left" src="/C-PAC/images/AD_400_TT.png" width="400" height="400" title="image" alt="image"></p>

<p>One can visually appreciate slight changes in ADHD patients compared to controls. There is the need of further analyzing these results, but it is not the aim of this study. This result outlined the possibility that some parcellations are better suited for specific analyses, and that the ability of different ROI layouts to parcellate a brain, may impact on the capacity of extracting information from the dataset.</p>

<p>Being the calculation of the measures the same for 90, 400 and 1000 regions, I can just visually appreciate clear structures in the parcellation of 90 regions (which does not actually say much about the data, that should be furtherly analyzed). This could have a major reason in the way that different parcellation masks are created. The measures were also tested over the same data in Matlab having the same results to test wheter our methods were correct or not.</p>

<h4>Repository and invitation to collaborate</h4>

<p>It was an important moment for us to be able to start interact on Github for two main reasons. Firstly, to be able to discuss and comment in a more applied way and have this in a single repository that everyone included on the complexity toolboxes could access (included CMI!). And secondly to have a repository that deployed on our cluster allow us to process large datasets to validate and document. This repository has unified on:</p>

<p><a href="https://github.com/roijo/C-PAC_complexitytools">https://github.com/roijo/C-PAC_complexitytools</a></p>

<p>Similarly, knowing well ADHD200 and ABIDE (CORR is also there) was a necessary task to do that we are doing in common.</p>

<p>Finally, I have added a slightly modificated function used in a previous work by Cameron, that saves the results into a Nifti file, making it easier to keep the results and export them.</p>

<hr />
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/C-PAC/blog/2015/06/30/midterm-summary-and-next-objectives/">Midterm Summary and Next Objectives</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-06-30T12:02:55+02:00'><span class='date'><span class='date-month'>Jun</span> <span class='date-day'>30</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>12:02 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>As we have reached the midterm of the project, We are writing this post as a summary of what we have been working on and which are our next objectives. Our overall evaluation of our work is positive and we are excited about keep the coding and learning.</p>

<h4><strong>Theory and discussion</strong></h4>

<p>In one hand, we have been weekly discussing about the measures we had to implement, having debates about the information we could get from them and feasibility and practicality of these measures integrated in CPAC and in terms of development. Also, it has been a hard-work of researching and learning about new techniques and tools used in the field, linked not only to measures related to non-linear analysis of the series, but also to a wide variety of preprocessing techniques, optimization and python language learning. Our weekly discussions about data and integration of other imaging environments and other parts of CPAC (ie. FSL have been stimulating).</p>

<h4><strong>Coding</strong></h4>

<p>In the other hand, as a consequence of the previous point, we have accomplished the goal of implementing several measures, helper functions and tools building partially a toolbox for the analysis of non-linear information of series that will need triming and revision, on the principles of utility and complementarity. Organisation of these measures and outputs are also to come.</p>

<p>I have developed 4 working workflows of measures based on correlation and Information Theory between pairs of variables (Ivan has developed others complementing my work):</p>

<ul>
<li>Correlation WF</li>
<li>Partial Correlation WF</li>
<li>Mutual Information WF</li>
<li>Transfer Entropy WF</li>
</ul>


<p>Additionally, the toolbox has several measures and helper functions some more completed than others that we are polishing and comparing to select some as to include in the toolbox:</p>

<ul>
<li>Shannon entropy</li>
<li>ApEn and SampEn (sampling entropies)</li>
<li>Conditional entropies</li>
<li>Entropy Correlation Coefficient</li>
<li>Phase synchronization (as explained in my last entry)</li>
<li>Phase Locking Values</li>
<li>TE based in covariances for gaussian variables (no need of discretization).</li>
<li>Entropy Correlation Coefficient</li>
<li>Helper functions:

<ul>
<li>Voxel-wise timeseries generator from fMRI data</li>
<li>ROI timeseries generator from fMRI data</li>
<li>Transform (BIC discretization of signals based on Equiquantization criteria and discretization formalisms by Ivan)</li>
<li>Frequency filters and bands</li>
<li>Phase extractors</li>
</ul>
</li>
</ul>


<p>And also a Granger Causality (GC) module (Implementing Pairwise Conditional GC and MultiVariate GC using a VAR model) that still is under last testings and bug-correcting phase with the following functions that can be found in <a href="https://github.com/erramuzpe/C-PAC/blob/series_mod/CPAC/series_mod/mvgc.py">GitHub</a>:</p>

<ul>
<li>Granger Causality functions based on VAR model:

<ul>
<li>tsdata_to_autocov: Timeseries to autocovariance matrix calculation</li>
<li>autocov_to_var: Calculation of the coefficients and the residuals using the VAR model.</li>
<li>autocov_to_pwcgc: Calculation of the Pairwise Granger Causality using the residuals previously calculated.</li>
<li>autocov_to_mvgc: Calculation of the Multivariate Granger Causality using the residuals previously calculated.</li>
</ul>
</li>
</ul>


<h4><strong>Testing over real data</strong></h4>

<p>Finally, there has been an application of the developed measures to real fMRI data, having reported some preliminary results. These results can be found in previous entries of this blog:</p>

<p><a href="http://erramuzpe.github.io/C-PAC/blog/2015/06/03/advances-of-the-last-week/">Correlation, Entropies and Mutual Information</a>, <a href="http://erramuzpe.github.io/C-PAC/blog/2015/06/17/new-measures-transfer-entropy/">Transfer Entropy</a> and <a href="http://erramuzpe.github.io/C-PAC/blog/2015/06/18/some-examples-with-phase-synchrony-measures/">Phase Synchrony</a>.</p>

<p>We are towards starting using extensively the NCoRR database for real data usage with the measures and establish the use of new atlases to extend the 90 ROIs that we have been working with to 512 or/and 1024 regions and voxel-wise for modelisation in our cluster. Also, we are dedicated to graphic representation and results for documentation. An basic idea idea of how we could represent our matrices using networkx capabilities is explained <a href="http://wiki.biac.duke.edu/biac:analysis:resting_pipeline">here</a> as orientative, by taking correlation matrixes (could be any other measure&rsquo;s bi-directional results matrix) and generating figures like these:</p>

<p><img class="left" src="http://wiki.biac.duke.edu/_media/biac:analysis:3d_functionalconnectome.png?cache=&w=900&h=738&tok=7a2a44" width="350" height="350" title="image" alt="image"></p>

<p><img class="center" src="http://wiki.biac.duke.edu/_media/biac:analysis:2d_functionalconnectome.png?w=400&h=442&tok=5ee755" width="300" height="350" title="image" alt="image"></p>

<hr />

<h2><strong>Next objectives</strong></h2>

<p>Even if we are successfully completing our initial plan, we have still work to do:</p>

<p>The obvious point is that testing these tools in real data and modelling them and their parameters for robustness and effective documentation, comparing also several situations and testing the code efficiency and stability.</p>

<p><img class="center" src="/C-PAC/images/calendar_midterm.png" width="500" height="500" title="image" alt="image"></p>

<p>Other practicalities I would like to point some TO-DO&rsquo;s and objectives towards the second (and last) part of the project:</p>

<ul>
<li>Merging of both students repositories and having a copy of it in a cluster, allowing running studies on it.</li>
<li>Solve code problems and developer strategies alike to CPAC already existing code (efficiency and some errors in measures).</li>
<li>Work on the integration with CPAC (GUI building and dependencies).</li>
<li>Keep following the initial plan: Cross-entropies, Fingerprints and Avalanche-point process modelisation. Discuss extensively about features to add, most relevant measures and future aplications over real data.</li>
<li>Implement measures of multiscale dynamics .</li>
<li>We have now a primitive and easy version of calculating the numbers of bins via Equantization. We are discussing more advanced methods to do it and it is likely to develop an alternative.</li>
<li>Related to frecuencies (develop using what we already have as a base):

<ul>
<li>Implement Sample Entropies.</li>
<li>Fingerprints -> Determine important frequencies. Use of the power spectrum.</li>
</ul>
</li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/C-PAC/blog/2015/06/18/some-examples-with-phase-synchrony-measures/">Some Examples With Phase Synchrony Measures</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-06-18T15:02:43+02:00'><span class='date'><span class='date-month'>Jun</span> <span class='date-day'>18</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>3:02 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>The <a href="https://en.wikipedia.org/wiki/Hilbert_transform">Hilbert Transform</a> is a linear operator which takes a function, u(t), and produces a function, H(u)(t), with the same domain.</p>

<p>In python, we can compute the <a href="http://en.wikipedia.org/wiki/Analytic_signal">analytic signal</a>, using the Hilbert transform. This analytic signal is used for many things, like computing the envelope of a signal or the instantaneous phase of the signal.
Our calculation of the instantaneous phase is in the range [0,1], computed over the cos() function of the angle of the Hilbert Transform coefficients.
We have choosen a random signal of an fMRI file to show the example:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='py'><span class='line'><span class="n">env</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">sigtool</span><span class="o">.</span><span class="n">hilbert</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='py'><span class='line'><span class="n">ht</span> <span class="o">=</span> <span class="n">sigtool</span><span class="o">.</span><span class="n">hilbert</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
</span><span class='line'><span class="n">px</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">angle</span><span class="p">(</span><span class="n">ht</span><span class="p">)</span> <span class="c"># instantaneous phase</span>
</span><span class='line'><span class="n">inst_p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">px</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="c"># modulus of the angle in [0,1]</span>
</span></code></pre></td></tr></table></div></figure>


<p><img class="center" src="/C-PAC/images/signal_env.png" width="500" height="500" title="image" alt="image"></p>

<p>With this instantaneous phase, we can code easyly the two functions that were shown in the previous post, the Phase Synchronization parameter and the Phase Locking Value. For visualization purposes, here is shown a good example of three signals, the first one is from a region far from the other ones. The last two signals are in regions close to another (it is supposed they will be more synchronized between them than with the first one, which is distant).</p>

<p><img class="center" src="/C-PAC/images/signals_phase.png" width="500" height="500" title="image" alt="image"></p>

<p><img class="center" src="/C-PAC/images/signals_phase2.png" width="500" height="500" title="image" alt="image"></p>

<p>The PLV values, validating our initial hypothesis, are the following:</p>

<ul>
<li>PLV(S1,S2) = 0.43</li>
<li>PLV(S1,S3) = 0.41</li>
<li>PLV(S2,S3) = 0.86</li>
</ul>


<p>The PLV values for the 90 regions for a particular random subject of our dataset is shown in the next picture:</p>

<p><img class="center" src="/C-PAC/images/PLV_mat.png" width="350" height="350" title="image" alt="image"></p>

<p>Which unveils similar structures to the ones got with TE, MI and Correlations.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/C-PAC/blog/2015/06/17/new-measures-transfer-entropy/">New Measures: Transfer Entropy, Phase Synchronization and Phase Locking Value</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-06-17T11:34:54+02:00'><span class='date'><span class='date-month'>Jun</span> <span class='date-day'>17</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>11:34 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>This week we have been centered in developing new measures for C-PAC. The first one, Transfer Entropy, is related to the first measures we did (Entropy, Mutual Information) addind a lag-time to one of the series, while the second and the third ones have a frequency based approach based on phase synchronization analysys.</p>

<h2><strong>Transfer Entropy</strong></h2>

<p>The Transfer Entropy has been developed following our interest in measures which would compare past of the signals with his later values (like Granger Causality) and mixing with the Information Theory concept.</p>

<p><a href="https://en.wikipedia.org/wiki/Transfer_entropy">Transfer Entropy</a> is a non-parametric statistic measuring the amount of directed (time-asymmetric) transfer of information between two random processes. Transfer entropy from a process X to another process Y is the amount of uncertainty reduced in future values of Y by knowing the past values of X given past values of Y and is denoted as:</p>

<p><img class="center" src="/C-PAC/images/TE_formula.png" width="500" height="500" title="image" alt="image"></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='py'><span class='line'><span class="k">def</span> <span class="nf">transfer_entropy</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">lag</span><span class="p">):</span>
</span><span class='line'>    <span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
</span><span class='line'>    <span class="kn">from</span> <span class="nn">CPAC.series_mod</span> <span class="kn">import</span> <span class="n">cond_entropy</span>
</span><span class='line'>    <span class="kn">from</span> <span class="nn">CPAC.series_mod</span> <span class="kn">import</span> <span class="n">entropy</span>
</span><span class='line'>
</span><span class='line'>    <span class="c"># future of i</span>
</span><span class='line'>    <span class="n">Fi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="o">-</span><span class="n">lag</span><span class="p">)</span>
</span><span class='line'>    <span class="c"># past of i</span>
</span><span class='line'>    <span class="n">Pi</span> <span class="o">=</span> <span class="n">X</span>
</span><span class='line'>    <span class="c"># past of j</span>
</span><span class='line'>    <span class="n">Pj</span> <span class="o">=</span> <span class="n">Y</span>
</span><span class='line'>
</span><span class='line'>    <span class="c">#Transfer entropy</span>
</span><span class='line'>    <span class="n">Inf_from_Pi_to_Fi</span> <span class="o">=</span> <span class="n">cond_entropy</span><span class="p">(</span><span class="n">Fi</span><span class="p">,</span> <span class="n">Pi</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="c">#same as cond_entropy(Fi, Pi_Pj)</span>
</span><span class='line'>    <span class="n">Hy</span> <span class="o">=</span> <span class="n">entropy</span><span class="p">(</span><span class="n">Pi</span><span class="p">,</span><span class="n">Pj</span><span class="p">)</span>
</span><span class='line'>    <span class="n">Hyx</span> <span class="o">=</span> <span class="n">entropy</span><span class="p">(</span><span class="n">Fi</span><span class="p">,</span><span class="n">Pj</span><span class="p">,</span><span class="n">Pi</span><span class="p">)</span>
</span><span class='line'>    <span class="n">Inf_from_Pi_Pj_to_Fi</span> <span class="o">=</span> <span class="n">Hyx</span> <span class="o">-</span> <span class="n">Hy</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">TE_from_j_to_i</span> <span class="o">=</span> <span class="n">Inf_from_Pi_to_Fi</span><span class="o">-</span><span class="n">Inf_from_Pi_Pj_to_Fi</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="n">TE_from_j_to_i</span>
</span></code></pre></td></tr></table></div></figure>


<p>From this, we have built also a workflow that allows to calculate the TE values over a series of fMRI data. A first test has been carried out with real data using the same dataset of previous entries (a series of 28 subjects and a parcellation of 90 ROIs). Descriptively, mean values over subjects for the TE calculation was reported (left) and connectivity as unweighted was found by thresholding TE values with 0.7 (right).</p>

<p><img class="left" src="/C-PAC/images/TE_mean.png" width="300" height="300" title="image" alt="image">
<img class="right" src="/C-PAC/images/TE_conn.png" width="400" height="400" title="image" alt="image"></p>

<h2><strong>Phase synchronization and PLV</strong></h2>

<p>As explained las week, we can obtain the analytical signals using the Hilbert transform. This analytic signal represents a signal in the time domain as a rotating vector with an instantaneous phase, phi(t), and amplitude.</p>

<p>The global level of phase synchrony is given by the parameter R(t), after calculating the modulus of the phase, taking values in the [0,1] range (being 0 completely asynchroneous and 1 completely synchronized, respectively):</p>

<p><img class="center" src="/C-PAC/images/r_param.png" width="300" height="300" title="image" alt="image"></p>

<p>Which, translated to python, is:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='py'><span class='line'><span class="k">def</span> <span class="nf">phase_sync</span><span class="p">(</span><span class="n">X</span><span class="p">):</span> <span class="c"># Computes the PS_value as explained in Ponce et al. 2015</span>
</span><span class='line'><span class="c">#this code is wrong, contact the author</span>
</span></code></pre></td></tr></table></div></figure>


<p>For quantifying the pairwise phase relation between two given brain regions (timeseries) <em>k</em> and <em>l</em>, Phase-Locking Value (PLV) has to be calculated as:</p>

<p><img class="center" src="/C-PAC/images/plv.png" width="300" height="300" title="image" alt="image"></p>

<p>Again, translated to python:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='py'><span class='line'><span class="k">def</span> <span class="nf">PLV</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">):</span>
</span><span class='line'><span class="c">#this code is wrong, contact the author</span>
</span></code></pre></td></tr></table></div></figure>


<p>Some examples with regard of phase synchronization measures will be shown in the next entry of the blog.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/C-PAC/blog/2015/06/11/towards-frequency-domain-analysis-phase-synchronization/">Towards Frequency Domain Analysis and Phase Synchronization</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-06-11T11:54:16+02:00'><span class='date'><span class='date-month'>Jun</span> <span class='date-day'>11</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>11:54 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>This week we have been discussing further about the possibility of developing some frequency analysis tools to integrate in the package. Although CPAC already has some tools to work on the frequency domain, we are thinking in building up some valuable scripts that allow us to capture information using the frequency domain. Our intention is to develop measures such Phase Synchronization and identification of patterns based on frequency domain analysis, to be used as features for Fingerprint analysis. Specifically, as starting point, we are going to take as guide and example the methods described in the paper by Ponce et al. <a href="http://journals.plos.org/ploscompbiol/article?id=10.1371/journal.pcbi.1004100">[1]</a>, with the intention of performing a similar analysis over fMRI. Our goal is to do so and extending them with measures like temporal power spectral density (PSDT).</p>

<h2><strong>Phase synchronization analysis</strong></h2>

<p>This kind of analysis needs of the extraction ef the phases of the fMRI timeseries. We can obtain the analytical signals using the Hilbert transform. This analytic signal represents a signal in the time domain as a rotating vector with an instantaneous phase, phi(t), and amplitude.</p>

<p>The global level of phase synchrony is given by the parameter R(t), taking values in the [0,1] range (being 0 completely asynchroneous and 1 completely synchronized, respectively):</p>

<p><img class="center" src="/C-PAC/images/r_param.png" width="300" height="300" title="image" alt="image"></p>

<p>For quantifying the pairwise phase relation between two given brain regions (timeseries) <em>k</em> and <em>l</em>, Phase-Locking Value (PLV) has to be calculated as:</p>

<p><img class="center" src="/C-PAC/images/plv.png" width="300" height="300" title="image" alt="image"></p>

<p>Last week, I already deveveloped a simple filter and this week I have been practicing further with the numpy.signal package. Some example of code, partially changed from <a href="http://gribblelab.org/scicomp/09_Signals_sampling_filtering.html">this</a> excellent tutorial. Under each block of code, I have plotted an example over fMRI data (it is clear that the used data has been already preprocessed and filtered):</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='py'><span class='line'>  <span class="kn">from</span> <span class="nn">numpy</span> <span class="kn">import</span> <span class="o">*</span>
</span><span class='line'>  <span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="o">*</span> <span class="c"># not a good practice, but just for the examples</span>
</span><span class='line'>
</span><span class='line'>  <span class="c"># Power Spectra calculation</span>
</span><span class='line'>  <span class="c"># construct signal</span>
</span><span class='line'>  <span class="n">t</span> <span class="o">=</span> <span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1001</span><span class="p">)</span>
</span><span class='line'>  <span class="n">y</span> <span class="o">=</span> <span class="n">sin</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="o">*</span><span class="n">t</span><span class="o">*</span><span class="mi">6</span><span class="p">)</span> <span class="o">+</span> <span class="n">sin</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="o">*</span><span class="n">t</span><span class="o">*</span><span class="mi">10</span><span class="p">)</span> <span class="o">+</span> <span class="n">sin</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="o">*</span><span class="n">t</span><span class="o">*</span><span class="mi">13</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="c"># compute FFT and the magnitude spectrum</span>
</span><span class='line'>  <span class="n">F</span> <span class="o">=</span> <span class="n">fft</span><span class="o">.</span><span class="n">fft</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
</span><span class='line'>  <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>             <span class="c"># number of samples</span>
</span><span class='line'>  <span class="n">dt</span> <span class="o">=</span> <span class="mf">0.001</span>             <span class="c"># inter-sample time difference</span>
</span><span class='line'>  <span class="n">w</span> <span class="o">=</span> <span class="n">fft</span><span class="o">.</span><span class="n">fftfreq</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">dt</span><span class="p">)</span>     <span class="c"># gives us a list of frequencies for the FFT</span>
</span><span class='line'>  <span class="n">ipos</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">w</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span>
</span><span class='line'>  <span class="n">freqs</span> <span class="o">=</span> <span class="n">w</span><span class="p">[</span><span class="n">ipos</span><span class="p">]</span>        <span class="c"># only look at positive frequencies</span>
</span><span class='line'>  <span class="n">mags</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">F</span><span class="p">[</span><span class="n">ipos</span><span class="p">])</span>    <span class="c"># magnitude spectrum</span>
</span><span class='line'>  <span class="n">phase</span> <span class="o">=</span> <span class="n">imag</span><span class="p">(</span><span class="n">F</span><span class="p">[</span><span class="n">ipos</span><span class="p">])</span>  <span class="c"># phase component</span>
</span></code></pre></td></tr></table></div></figure>


<p><img class="center" src="/C-PAC/images/plot1.png" width="300" height="300" title="image" alt="image"></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='py'><span class='line'>  <span class="c"># Inverse Fast Fourier transform (IFFT) (reconstruction from freq domain)</span>
</span><span class='line'>  <span class="c"># construct signal</span>
</span><span class='line'>  <span class="n">t</span> <span class="o">=</span> <span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1001</span><span class="p">)</span>
</span><span class='line'>  <span class="n">y</span> <span class="o">=</span> <span class="n">sin</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="o">*</span><span class="n">t</span><span class="o">*</span><span class="mi">6</span><span class="p">)</span> <span class="o">+</span> <span class="n">sin</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="o">*</span><span class="n">t</span><span class="o">*</span><span class="mi">10</span><span class="p">)</span> <span class="o">+</span> <span class="n">sin</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="o">*</span><span class="n">t</span><span class="o">*</span><span class="mi">13</span><span class="p">)</span>
</span><span class='line'>  
</span><span class='line'>  <span class="c"># compute FFT and the magnitude spectrum</span>
</span><span class='line'>  <span class="n">F</span> <span class="o">=</span> <span class="n">fft</span><span class="o">.</span><span class="n">fft</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
</span><span class='line'>  <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>             <span class="c"># number of samples</span>
</span><span class='line'>  <span class="n">dt</span> <span class="o">=</span> <span class="mf">0.001</span>             <span class="c"># inter-sample time difference</span>
</span><span class='line'>  <span class="n">w</span> <span class="o">=</span> <span class="n">fft</span><span class="o">.</span><span class="n">fftfreq</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">dt</span><span class="p">)</span>     <span class="c"># gives us a list of frequencies for the FFT</span>
</span><span class='line'>  <span class="n">ipos</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">w</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span>
</span><span class='line'>  <span class="n">freqs</span> <span class="o">=</span> <span class="n">w</span><span class="p">[</span><span class="n">ipos</span><span class="p">]</span>        <span class="c"># only look at positive frequencies</span>
</span><span class='line'>  <span class="n">mags</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">F</span><span class="p">[</span><span class="n">ipos</span><span class="p">])</span>    <span class="c"># magnitude component</span>
</span><span class='line'>  <span class="n">phase</span> <span class="o">=</span> <span class="n">imag</span><span class="p">(</span><span class="n">F</span><span class="p">[</span><span class="n">ipos</span><span class="p">])</span>  <span class="c"># phase component</span>
</span><span class='line'>  <span class="c"># inverse</span>
</span><span class='line'>  <span class="n">yr</span> <span class="o">=</span> <span class="n">fft</span><span class="o">.</span><span class="n">ifft</span><span class="p">(</span><span class="n">F</span><span class="p">)</span>
</span><span class='line'>  
</span></code></pre></td></tr></table></div></figure>


<p><img class="center" src="/C-PAC/images/figure_2.png" width="300" height="300" title="image" alt="image"></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
</pre></td><td class='code'><pre><code class='py'><span class='line'>  <span class="c">## Filtering</span>
</span><span class='line'>  <span class="c"># construct signal </span>
</span><span class='line'>  <span class="n">t</span> <span class="o">=</span> <span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1001</span><span class="p">)</span>
</span><span class='line'>  <span class="n">y</span> <span class="o">=</span> <span class="n">sin</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="o">*</span><span class="n">t</span><span class="o">*</span><span class="mi">6</span><span class="p">)</span> <span class="o">+</span> <span class="n">sin</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="o">*</span><span class="n">t</span><span class="o">*</span><span class="mi">10</span><span class="p">)</span> <span class="o">+</span> <span class="n">sin</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="o">*</span><span class="n">t</span><span class="o">*</span><span class="mi">13</span><span class="p">)</span>
</span><span class='line'>  
</span><span class='line'>  <span class="c"># compute FFT and the magnitude spectrum</span>
</span><span class='line'>  <span class="n">F</span> <span class="o">=</span> <span class="n">fft</span><span class="o">.</span><span class="n">fft</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
</span><span class='line'>  <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>             <span class="c"># number of samples</span>
</span><span class='line'>  <span class="n">dt</span> <span class="o">=</span> <span class="mf">0.001</span>             <span class="c"># inter-sample time difference</span>
</span><span class='line'>  <span class="n">w</span> <span class="o">=</span> <span class="n">fft</span><span class="o">.</span><span class="n">fftfreq</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">dt</span><span class="p">)</span>     <span class="c"># gives us a list of frequencies for the FFT</span>
</span><span class='line'>  <span class="n">ipos</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">w</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span>
</span><span class='line'>  <span class="n">freqs</span> <span class="o">=</span> <span class="n">w</span><span class="p">[</span><span class="n">ipos</span><span class="p">]</span>        <span class="c"># only look at positive frequencies</span>
</span><span class='line'>  <span class="n">mags</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">F</span><span class="p">[</span><span class="n">ipos</span><span class="p">])</span>    <span class="c"># magnitude component</span>
</span><span class='line'>  <span class="n">phase</span> <span class="o">=</span> <span class="n">imag</span><span class="p">(</span><span class="n">F</span><span class="p">[</span><span class="n">ipos</span><span class="p">])</span>  <span class="c"># phase component</span>
</span><span class='line'>  <span class="n">ip</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">F</span><span class="o">&gt;</span><span class="mi">5</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>     <span class="c"># find peaks in FFT</span>
</span><span class='line'>  <span class="n">Fs</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">F</span><span class="p">)</span>           <span class="c"># make a copy of the signal FFT</span>
</span><span class='line'>  <span class="n">Fs</span><span class="p">[</span><span class="n">ip</span><span class="p">[[</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">]]]</span> <span class="o">=</span> <span class="mi">0</span>      <span class="c"># set peaks corresponding to </span>
</span><span class='line'>
</span><span class='line'>  <span class="n">yf</span> <span class="o">=</span> <span class="n">fft</span><span class="o">.</span><span class="n">ifft</span><span class="p">(</span><span class="n">Fs</span><span class="p">)</span>          <span class="c"># reconstruct</span>
</span><span class='line'>  <span class="n">ip</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">F</span><span class="o">&gt;</span><span class="mi">5</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>     <span class="c"># find peaks in FFT</span>
</span><span class='line'>  <span class="n">Ff</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">F</span><span class="p">)</span>           <span class="c"># make a copy of the signal FFT</span>
</span><span class='line'>  <span class="n">Ff</span><span class="p">[</span><span class="n">ip</span><span class="p">[[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">]]]</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c"># set 10Hz and 13Hz peaks to zero</span>
</span><span class='line'>  <span class="n">magsf</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">Ff</span><span class="p">[</span><span class="n">ipos</span><span class="p">])</span>  <span class="c"># magnitude component</span>
</span><span class='line'>  <span class="n">phasef</span> <span class="o">=</span> <span class="n">imag</span><span class="p">(</span><span class="n">Ff</span><span class="p">[</span><span class="n">ipos</span><span class="p">])</span><span class="c"># phase component</span>
</span><span class='line'>  <span class="n">yf</span> <span class="o">=</span> <span class="n">fft</span><span class="o">.</span><span class="n">ifft</span><span class="p">(</span><span class="n">Ff</span><span class="p">)</span>          <span class="c"># reconstruct</span>
</span><span class='line'>  
</span><span class='line'>  <span class="n">yr</span> <span class="o">=</span> <span class="n">fft</span><span class="o">.</span><span class="n">ifft</span><span class="p">(</span><span class="n">F</span><span class="p">)</span>
</span><span class='line'>  
</span></code></pre></td></tr></table></div></figure>


<p><img class="center" src="/C-PAC/images/figure_3.png" width="300" height="300" title="image" alt="image"></p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/C-PAC/posts/2">&larr; Older</a>
    
    <a href="/C-PAC/blog/archives">Blog Archives</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/C-PAC/blog/2015/08/20/last-week-of-coding-time-for-reviewing-and-documenting/">Last Week of Coding: Time for Reviewing and Documenting</a>
      </li>
    
      <li class="post">
        <a href="/C-PAC/blog/2015/08/14/clustering-and-avalanche-detection-algorithms/">Clustering and Avalanche Detection Algorithms</a>
      </li>
    
      <li class="post">
        <a href="/C-PAC/blog/2015/08/07/integration-of-measures-and-point-process-developing/">Integration of Measures and Point Process Developing</a>
      </li>
    
      <li class="post">
        <a href="/C-PAC/blog/2015/07/22/discussion-and-planning-gui-for-nltsa-and-testing-synchrony-measures/">Discussion and Planning GUI for NLTSA and Testing Synchrony Measures</a>
      </li>
    
      <li class="post">
        <a href="/C-PAC/blog/2015/07/15/implementing-modules-in-the-gui/">Implementing Modules in CPAC&#8217;s GUI</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  
  <a href="https://github.com/erramuzpe">@erramuzpe</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'erramuzpe',
            count: 0,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/C-PAC/javascripts/github.js" type="text/javascript"> </script>
</section>





  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2015 - github.com/erramuzpe -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'toolsforcpac';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
